rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {
    
    // Regla para la colección de usuarios
    match /users/{userId} {
      // Permitir lectura si el usuario está autenticado
      allow read: if request.auth != null;
      
      // Permitir escritura solo si el usuario está autenticado
      // y el documento corresponde al email del usuario autenticado
      allow write: if request.auth != null 
                   && (request.auth.token.email == userId 
                       || request.resource.data.email == request.auth.token.email);
      
      // Permitir creación si el usuario está autenticado
      allow create: if request.auth != null 
                    && request.resource.data.email == request.auth.token.email;
      
      // Permitir actualización si el usuario está autenticado
      // y el documento pertenece al usuario autenticado
      allow update: if request.auth != null 
                    && (resource.data.email == request.auth.token.email 
                        || request.resource.data.email == request.auth.token.email);

      // Subcolección de métodos de pago
      match /payment_methods/{cardId} {
        // Permitir lectura y escritura solo si el usuario está autenticado
        // y el documento pertenece al usuario
        allow read, write: if request.auth != null
                          && request.auth.token.email == userId;
      }

      // Subcolección de pedidos
      match /pedidos/{pedidoId} {
        // Permitir lectura y escritura solo si el usuario está autenticado
        // y el documento pertenece al usuario
        allow read, write: if request.auth != null
                          && request.auth.token.email == userId;
      }
    }

    // Regla para otras colecciones (ubicaciones, etc.)
    match /ubicaciones/{ubicacionId} {
      allow read: if request.auth != null;
      allow write: if request.auth != null;
    }

    // Regla para códigos de descuento - lectura pública, escritura solo para admins
    match /codigos_descuento/{codigoId} {
      // Permitir lectura pública para que cualquier usuario pueda validar códigos
      allow read: if true;
      // La escritura solo debería ser para administradores (por ahora se puede hacer desde la consola de Firebase)
      allow write: if false;
    }

    // Regla por defecto: denegar todo lo demás
    match /{document=**} {
      allow read, write: if false;
    }
  }
}